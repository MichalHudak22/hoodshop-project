import{r as s,A as K,u as W,C as X,a as m,v as Z,j as e}from"./index-C-hwXzSE.js";const o="http://localhost:3001",oe=()=>{const{user:l}=s.useContext(K),S=W(),[j,D]=s.useState([]),[p,F]=s.useState(0),[M,A]=s.useState(!0),[g,E]=s.useState(null),[f,I]=s.useState(!1),[c,v]=s.useState(null),[x,_]=s.useState(0),{refreshCartCount:z}=s.useContext(X),[i,b]=s.useState({full_name:"",profile_email:"",birth_date:"",mobile_number:"",address:"",city:"",postal_code:"",payment_method:"card",card_number:"",card_expiry:"",card_cvc:""}),[N,w]=s.useState("DPD"),[u,y]=s.useState(0),[C,R]=s.useState([]);s.useEffect(()=>{m.get(`${o}/api/config/shipping-prices`).then(t=>{console.log("ðŸ”½ API shipping-prices:",t.data);const a=(t.data||[]).map(r=>({...r,price:parseFloat(r.price)}));R(a);const n=a.find(r=>r.name==="DPD");n&&(w("DPD"),y(n.price))}).catch(t=>console.error("Chyba pri naÄÃ­tanÃ­ cien dopravy:",t))},[]);const q=t=>{const a=t.target.value;w(a),b(r=>({...r,delivery_method:a}));const n=C.find(r=>r.name===a);y(n?parseFloat(n.price):0)};s.useEffect(()=>{l!=null&&l.token&&m.get(`${o}/user/profile`,{headers:{Authorization:`Bearer ${l.token}`}}).then(t=>v(t.data)).catch(t=>console.error("Error loading profile:",t))},[l]),s.useEffect(()=>{const t=localStorage.getItem("sessionId")||Z();localStorage.setItem("sessionId",t),E(t)},[]),s.useEffect(()=>{if(!g)return;const t=l!=null&&l.token?{Authorization:`Bearer ${l.token}`}:{"x-session-id":g};m.get(`${o}/api/cart`,{headers:t}).then(a=>{D(a.data),F(a.data.reduce((n,r)=>n+r.price*r.quantity,0))}).catch(a=>console.error("Cart error:",a)).finally(()=>A(!1))},[g,l]),s.useEffect(()=>{l!=null&&l.token&&(f?m.get(`${o}/user/profile`,{headers:{Authorization:`Bearer ${l.token}`}}).then(t=>{const a=t.data;b(n=>{var r;return{...n,full_name:a.name||"",profile_email:a.profile_email||"",birth_date:((r=a.birth_date)==null?void 0:r.split("T")[0])||"",mobile_number:a.mobile_number||"",address:a.address||"",city:a.city||"",postal_code:a.postal_code||""}})}).catch(t=>console.error("Profile error:",t)):b({full_name:"",profile_email:"",birth_date:"",mobile_number:"",address:"",city:"",postal_code:"",payment_method:"card"}))},[f,l]);const h=t=>b(a=>({...a,[t.target.name]:t.target.value})),[ee,P]=s.useState(!1),B=async()=>{const{full_name:t,profile_email:a,mobile_number:n,address:r,city:ae,postal_code:T,payment_method:Y,card_number:O,card_expiry:Q,card_cvc:V}=i,k=[{field:"full_name",label:"Full Name"},{field:"profile_email",label:"Email"},{field:"mobile_number",label:"Mobile Number"},{field:"address",label:"Address"},{field:"city",label:"City"},{field:"postal_code",label:"Postal Code"}].filter(({field:d})=>!i[d]);if(k.length>0){const d=k.map(J=>J.label).join(", ");return alert(`Please fill in all required fields: ${d}`)}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return alert("Please enter a valid email address.");if(!/^\d{9,}$/.test(n))return alert("Please enter a valid mobile number (only digits, at least 9 numbers).");if(!/^\d+$/.test(T))return alert("Please enter a valid postal code (only digits).");if(Y==="card"&&(!O||!Q||!V))return alert("Please fill in all card details.");const $=l!=null&&l.token?{Authorization:`Bearer ${l.token}`}:{"x-session-id":g},G=x*.1,H=Math.max(p+u-G,0);P(!0);try{if(await m.post(`${o}/api/orders`,{...i,delivery_method:N,delivery_price:u,total_price:H,cartItems:j,usedPoints:x},{headers:$}),_(0),l!=null&&l.token){const d=await m.get(`${o}/user/profile`,{headers:{Authorization:`Bearer ${l.token}`}});v(d.data)}await m.delete(`${o}/api/cart`,{headers:$}),z(),S("/thank-you")}catch(d){console.error("Payment error:",d),alert("Payment failed. Try again.")}finally{P(!1)}},U=x*.1,L=Math.max(p+u-U,0)*.05*10;return M?e.jsx("p",{children:"Loading..."}):e.jsxs("div",{className:"relative bg-cover bg-center md:py-16",style:{backgroundImage:"url('/img/bg-shop.jpg')",backgroundAttachment:"fixed"},children:[e.jsx("div",{className:"absolute inset-0 bg-black opacity-40 z-0"}),e.jsxs("section",{className:"relative z-10 w-full md:w-[90%] lg:w-[900px] mx-auto px-6 md:px-8 py-8 md:rounded-xl bg-black bg-opacity-60 md:border-2 border-gray-500",children:[e.jsx("h1",{className:"text-3xl lg:text-4xl text-blue-200 text-center font-bold mb-6",children:"Checkout"}),l&&e.jsx("div",{className:"mb-4 text-center",children:e.jsxs("label",{className:"inline-flex items-center text-blue-200 text-lg lg:text-xl",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:t=>I(t.target.checked),className:"mx-3 scale-150"}),"Use saved profile Information"]})}),e.jsxs("div",{className:"space-y-4 mb-6",children:[[["full_name","Full Name","text"],["profile_email","Email","email"],["birth_date","Birth Date","date"],["mobile_number","Mobile Number","tel"],["address","Address","text"],["city","City","text"],["postal_code","Postal Code","text"]].map(([t,a,n])=>e.jsxs("div",{className:"lg:flex lg:items-center lg:gap-4",children:[e.jsx("label",{className:"block text-white font-semibold lg:w-40 lg:text-lg",children:a}),e.jsx("input",{type:n,name:t,value:i[t],onChange:h,className:"w-full lg:w-[80%] p-2 border rounded focus:outline-none focus:bg-blue-100",required:["full_name","profile_email","mobile_number","address","city","postal_code"].includes(t)})]},t)),e.jsxs("div",{className:"text-white",children:[e.jsx("h2",{className:"text-2xl lg:text-3xl text-blue-200 font-bold text-center mb-6 pt-8",children:"Payment Method"}),e.jsxs("div",{className:"lg:flex lg:items-start lg:gap-5 lg:text-xl",children:[e.jsx("div",{className:"w-full lg:w-[40%] flex flex-col gap-3",children:["card","paypal","cash"].map(t=>e.jsxs("label",{className:`
              flex items-center gap-3 p-3 rounded-lg cursor-pointer
              border border-gray-600
              hover:border-blue-500
              transition-colors duration-200
              ${i.payment_method===t?"bg-blue-400 border-blue-600":"bg-gray-800"}
            `,children:[e.jsx("input",{type:"radio",name:"payment_method",value:t,checked:i.payment_method===t,onChange:h,className:"w-5 h-5 text-blue-500 accent-blue-500 cursor-pointer"}),e.jsx("span",{className:"capitalize select-none",children:t==="card"?"Card":t==="paypal"?"PayPal":"Cash on delivery"})]},t))}),e.jsxs("div",{className:"w-full lg:w-[60%] mt-6 lg:mt-0",children:[i.payment_method==="card"&&e.jsxs("div",{className:"space-y-4 text-white",children:[e.jsxs("div",{className:"lg:flex lg:items-center lg:gap-4",children:[e.jsx("label",{className:"lg:w-40 font-semibold text-lg",children:"Card Number"}),e.jsx("input",{type:"text",name:"card_number",value:i.card_number,onChange:h,className:"w-full p-2 border rounded focus:outline-none focus:bg-blue-100 text-black",placeholder:"1234 5678 9012 3456",maxLength:19})]}),e.jsxs("div",{className:"lg:flex lg:items-center lg:gap-4",children:[e.jsx("label",{className:"lg:w-40 font-semibold text-lg",children:"Expiry Date"}),e.jsx("input",{type:"month",name:"card_expiry",value:i.card_expiry,onChange:h,className:"w-full p-2 border rounded focus:outline-none focus:bg-blue-100 text-black"})]}),e.jsxs("div",{className:"lg:flex lg:items-center lg:gap-4",children:[e.jsx("label",{className:"lg:w-40 font-semibold text-lg",children:"CVC"}),e.jsx("input",{type:"text",name:"card_cvc",value:i.card_cvc,onChange:h,className:"w-full p-2 border rounded focus:outline-none focus:bg-blue-100 text-black",placeholder:"123",maxLength:4})]})]}),i.payment_method==="paypal"&&e.jsx("div",{className:"text-white italic",children:e.jsx("p",{children:"You'll be redirected to PayPal to complete your purchase."})}),i.payment_method==="cash"&&e.jsx("div",{className:"text-white italic",children:e.jsx("p",{children:"Pay with cash upon delivery. Please prepare the exact amount."})})]})]})]})]}),e.jsx("h2",{className:"text-2xl lg:text-3xl text-blue-200 font-bold text-center mb-6 pt-8",children:"Delivery Method"}),e.jsx("div",{className:"flex flex-col gap-5",children:C.map(t=>e.jsxs("label",{className:`flex w-[70%] md:w-[60%] m-auto items-center justify-between p-3 border rounded-lg cursor-pointer\r
                 bg-gray-50 peer-checked:bg-blue-200 peer-checked:text-blue-600`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"radio",name:"shipping",value:t.name,className:"w-5 h-5 peer",onChange:q,checked:N===t.name}),e.jsx("div",{children:e.jsx("p",{className:"font-medium text-lg",children:t.name})})]}),e.jsxs("span",{className:"font-semibold text-lg text-green-600",children:["â‚¬",t.price.toFixed(2)]})]},t.name))}),e.jsxs("ul",{className:"space-y-4 mb-6",children:[e.jsx("h2",{className:"text-2xl lg:text-3xl text-blue-200 font-bold text-center pt-8",children:"Items in Your Cart"}),j.map(t=>e.jsxs("li",{className:"flex justify-between bg-white p-4 shadow rounded",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("img",{src:`${o}${t.image}`,alt:t.name,className:"w-20 h-20 object-contain rounded border"}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold",children:t.name}),e.jsxs("p",{children:["Qty: ",t.quantity]})]})]}),e.jsxs("p",{className:"text-green-500 font-semibold text-lg",children:["$",(t.price*t.quantity).toFixed(2)]})]},t.id))]}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"mt-8 text-center text-blue-300 font-semibold text-lg",children:["You will earn ",Math.round(L)," loyalty points from this order."]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-4 text-center text-yellow-400 font-semibold text-lg",children:["You currently have ",c.loyalty_points," loyalty points (",(c.loyalty_points*.1).toFixed(2),"â‚¬ in discounts)."]}),e.jsxs("div",{className:"mt-2 text-center",children:[e.jsxs("label",{className:"block text-white mb-1",htmlFor:"usePoints",children:["Use loyalty points (max ",c.loyalty_points,"):"]}),e.jsx("input",{type:"number",id:"usePoints",min:0,max:c.loyalty_points,value:x,onChange:t=>{let a=Number(t.target.value);const n=Math.min(c.loyalty_points,Math.ceil((p+u)*10));a>n&&(a=n),a<0&&(a=0),_(a)},className:"text-black px-2 py-2 my-2 rounded w-32 text-center border-none font-bold text-xl outline-none focus:outline-none"}),e.jsxs("div",{className:"text-sm text-green-300 mt-1",children:["Thatâ€™s a discount of ",(x*.1).toFixed(2),"â‚¬"]}),e.jsxs("div",{className:"text-sm text-blue-300 mt-1",children:["Max usable for this order: ",Math.min(c.loyalty_points,Math.ceil((p+u)*10))," points"]})]})]}),e.jsxs("h2",{className:"text-white text-lg lg:text-2xl font-semibold",children:["Total: ",e.jsxs("span",{className:"text-green-500 text-2xl font-semibold",children:[Math.max(p+u-x*.1,0).toFixed(2),"â‚¬"]})]}),e.jsx("button",{onClick:B,className:"w-full lg:w-80 lg:text-xl bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded",children:"Confirm and Pay"})]})]})]})};export{oe as default};
